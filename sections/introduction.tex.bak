\chapter{Introduction}

%- (beskriv streaming idea)
% Link: http://www.bats.org.uk/pages/publications_and_resources.html

\section{Users}

\begin{itemize}
	\item Biologists
	\item Developers(users, Thor)
	\item Developers(Code, John)
	\item Supervisors
	\item Backend developers
\end{itemize}

\section{Use Cases}
The usecases have been found by talking to biologists that use sound recordings to do experiments with animals, and with the developers of the existing system. The list of usecases is not exhaustive but includes the most relevant usecases with unique requirements.

\subsection{Porpoise}
The biology department in Kerteminde conducts experiments with porpoises in order to gain an understanding of how their subsonic echolocation works. The US Defence Force currently use porpoises to find mines as they are much better than human designed solutions. The general testsetup is depicted in figure \ref{usecase:porpoise_experiment1}.
\begin{figure}[!h]
    \centering
	\includegraphics[width=\textwidth]{figures/porpoise_experiment1}
	\caption{Figure of testsetup of porpoise's echolocation. The two boxes indicate pierses, each with a biologist standing. On the piers 2, 8 hydrophones are mounted.}\label{usecase:porpoise_experiment1}
\end{figure}


Figure \ref{usecase:porpoise_experiment1} shows a porpoise swimming in a basin close to \textit{Biologist 1}.
When \textit{Biologist 2} throws bait in the basin, the porpoise will swim torwards the bait while emitting high frequency, narrow band clicks, in order to swim in the direction of the bait. A porpoise emits clicks at a frequency of $\approx$ 130 khz.
Since 8 microphones are mounted near the bait on piers 2, the recordingsystem is able to record the clicks emitted by the porpoise. This experiment exists in different variations where, for instance, different materials are mounted between the bait and the porpoise that tampers with the porpoise's clicks and hearing. The experiments are conducted using one batbox with 8 hydrophones.

These experiments use \textit{Trigger recordings} and \textit{Long recordings} as described in section \ref{sec:usecase:triggerrecording} and \ref{sec:usecase:longrecording} respectively.

\subsection{Live Underwater Laboratorium}
The biologists in Kerteminde has an ongoing project, where they want to enlighten students in folkeskoler and efterskoler about the nature under water. They want to to stream live sound from the ocean in Kerteminde. Furthermore, they want to show live measurements of salinity, Ph and temperature of the ocean to the students.
This system will also be used to investigate how ferries etc. affect the lives of the animals living in the ocean. Biologists usually do experiments of fish in captivity, but they know very little about the life in the ocean outside their window. Ideally the biologists wants to get an notification when a fish or animal of interest is located in the ocean around Fyn.


\subsection{Bats}
The biologists at SDU do experiments with bats to gain knowledge about how bats use their echolocation, where bats live, and where they live in the nature.
Some of the experiments are conducted as described in section \ref{sec:usecase:porpoise} with porpoises. Instead of doing the experiments in water, they are conducted in a batcage showed in figure \ref{fig:usecase:batcage}. When the bats fly towards the bait, the biologist can create a recording using the trigger mechanism, as described in \ref{sec:usecase:triggerrecording}.

\begin{figure}[!h]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{figures/batcage_cross}
        \caption{Figure of batcage with existing system's microphone mount}
        \label{fig:gull}
    \end{subfigure}
    ~ %add desired spacing between images, e. g. ~, \quad, \qquad, \hfill etc. 
    %(or a blank line to force the subfigure onto a new line)
    \begin{subfigure}[b]{0.45\textwidth}
        \includegraphics[width=\textwidth]{figures/batcage}
        \caption{Figure of the opposite end of the batcage}
        \label{fig:mouse}
    \end{subfigure}
    \caption{Pictures of batcage}\label{fig:usecase:batcage}
\end{figure}

Another set of experiments are conducted in panama. 8 microphones are mounted in a tree, in order to investigate which bat species live in the forest. As the microphones and the batbox is mounted in a forest, the batbox is running on battery. Due to the location of the recording system in a forest, it's cumbersome to get physical access to the system, to do maintenance like replacing battery, harddrives etc. The system do periodically \textit{short recordings} as described in section \ref{sec:usecase:shortrecordings}. 

A third experiment is done in Odense where the new hospital will be build.
%The idea is to investigate how the new hospital will affect the bats living in the area.
The idea is to put op N batboxes, each with 8 microphones in the area where the hospital will be build to get more knowledge about the bats that live in the area. During the conduct of the hospital and after the hospital has been build, the biologists want to know if the behaviour of bats have changed. The system should only do recordings in the nightly hour as bats are not active during daytime. This is described in section \ref{sec:usecase:shortrecordings}.

The biologists also have interest in mounting a batbox with a microphone on drones. An experiment is to manually steer a drone near a group of flying bats, to gain knowledge about how bats behave in the air, which species fly at different heights etc. This should in the future be automated such that two drones, each with 8 microphones and a batbox can point in the direction of the group of bats. In order to maintain the heading, the drones should emulate being a drone by emitting ultrasonic sounds which is then recorded by the microphones. The trigger recordings must be minimum 30 ms. To do this, processing of the recordings must be done online, as described in section \ref{sec:usecase:online}.
\todo{Question: App. where drones use echolocation?}
These experiments require long recordings as described in section \ref{sec:usecase:longrecording} in order to record while the drone is in the air and triggered-recording as described in section \ref{sec:usercase:longrecording} to listen for subsonic replies emitted by the drone.

\subsection{Frogs}
Biologists also have interest in recording frogs, in order to learn more about their vocalization capabilities. Frogs use advanced techniques to synchronize with other frogs, so they alternate vocalization to increase their change of being heard by females frogs. Furthermore they use techniques where they do vocalizing near a bigger male frog to amplify their vocalization to, as before, increase their change of getting hear by female frogs. Figure \ref{fig:usecase:frogs} shows an illustration of frogs vocalizing around a lake. Experiments are usually conducted by mounting 8 microphones and 1 batbox close to a lake. The system is running on battery and requires recording to be done in predefined period of time during daytime. This system requires short recordings as described in section \ref{sec:usecase:shortrecording}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\textwidth]{figures/usecases_frogs}
	\caption{Figure of frogs sitting around a lake while the batbox is recording with 4 microphones} \label{fig:usecase:frogs}
\end{figure}

\subsubsection{Drones}
Drones are used to take pictures of the ocean, to see where porpoises are living. Drones will also be used in the future to investigate where salmon\todo{not salmon but?} breed in Denmark, as this is not known. Since the drone is hovering over the ocean, the biologists want to lower a hydrophone into the water from the drone, to listen to porpoises and other sea activity. This is sketched in figure \ref{fig:usecase:drone}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.4\textwidth]{figures/usecase_drone}
	\caption{Figure of the drone with a hydrophone hanging form the drone. The hydrophone is lowered into water to listen to sea animals}\label{fig:usecase:drone}
\end{figure}

In the beginning the system will only use one hydrophone, but in the future the might use more to do ecolocation to get the position of the sound source in the ocean.
The system will do short recordings as described in section \ref{sec:usecase:shortrecording}, as they only want to record if the drone detects any activity in the ocean.

\subsection{Zebra Finches}
Biologists use Zebra Finches for investigating vocalization, as the Zebra finch has a stereotypical sound. Especially the tutoring session between a young bird and its father has been investigated thoroughly. In an experiment, a teleconference system for birds has been build. The two birds are physically isolated in boxes,
but can communicate via cameras, screens, microphones and speakers. One batbox has been used, where 1 microphone is placed in each of the two boxes.\citep{larsen2016system}
Figure \ref{fig:usecases:zebra:overview} shows the conceptual design of the experiment:

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.6\textwidth]{figures/zebrafinches_experiment1.png}
	\caption{Pictures of experiment with zebra finches where only microphones, batbox and speakers are depicted}\label{fig:usecases:zebra:overview}
\end{figure}
It should be noted, that only two microphones are in use in this system.
As the system is designed to replay tutoring sessions from previous experiments, it is required that the system can replay recordings.
The system uses long recordings as described in section \ref{fig:usecase:longrecording}.


\begin{figure}
    \centering
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{figures/recording_trigger.png}
        \caption{Trigger recording illustrated}
        \label{fig:usecase:triggerrecording}
    \end{subfigure}
    ~ %add desired spacing between images, e. g. ~, \quad, \qquad, \hfill etc. 
      %(or a blank line to force the subfigure onto a new line)
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{figures/recording_long.png}
        \caption{Long recording illustrated}
        \label{fig:usecase:longrecording}
    \end{subfigure}
    ~ %add desired spacing between images, e. g. ~, \quad, \qquad, \hfill etc. 
    %(or a blank line to force the subfigure onto a new line)
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{figures/recording_short.png}
        \caption{Short recording illustrated}
        \label{fig:usecase:shortrecording}
    \end{subfigure}
    \caption{Illustration of the three types of recordings}\label{fig:usecase:recordingtypes}
\end{figure}
\subsection{Long Recordings}\label{sec:usecase:longrecording}
Long recordings are used in experiments where it is required to do continuous recordings for, theoretically, indefinitely. Long recordings are used where either storage is always available or the local attached storage can be replaced when out of space. Long recordings  require external power is connected the system, and that it is not running on battery. A long recording is shown in figure \ref{sec:usecase:longrecording}.

\subsection{Trigger Recordings}\label{sec:usecase:triggerrecording}
Trigger recordings are used in experiments where it potentially takes a long time before the event of interest is happening. By using a trigger recording, the recording can be triggered after the event has happened, but where the event is saved in the recording. In figure \ref{fig:usecase:triggerrecording} two microphones are depicted with respect to time. When the system receives a trig, it will export the recording to the the biologist, starting at $trig-pre$ to $trig+post$. The duration of the recording will therefore be $pre+post$. The trig is usually received by a press on a button.

\subsection{Short Recordings}\label{sec:usecase:shortrecording}
Short recordings are used when the storage is limited or the batbox is not always powered up due to power constrains such as the batbox is running on battery. The start of the recording and duration must be specified such that the biologists can key in when the recordings should be conducted.
A short recording is depicted in figure \ref{fig:usecase:shortrecording}.

\subsection{Data Analysis}
%Analysis of recordings are usually done in one of three ways: online, offline or as batch processing.

By talking with biologists, the analysis of recording has been split into three groups: online, offline or batch processing.
\subsubsection{Online}\label{sec:usecase:online}
Online processing is when the processing is happening while the experiment is conducted. This implies that recordings and results can be used in the experiment such as in the \textit{Zebra Finches experiment}, where tampering with data online is important. Recordings can be saved, but is not required to. This also allows systems to only save the result of the processing meaning much less storage is needed.

\subsubsection{Offline}
Offline analysis is used in most use-cases where the recordings are saved to local storage. The processing of the recordings can be done when the storage is brought back from the test-location. When the recordings are replayed, it should emulate the online recordings.
It should be possible to replay the same recording multiple times, where it can be chosen when the replay should happen from. Furthermore it must be possible to specify the duration of the replay. It is required the replaying has a granularity of 1 second. In cases where multiple microphones or hydrophones together with sensors are recorded, it should be possible to specify which microphone or sensor to replay

\subsubsection{Batch Processing}
Batch processing is also happening offline, but in this case the recordings are exported as  files, which can be used on a supercomputer such as Abacus. The different between offline and Batch Processing is the fact, that in offline-analysis, the format of the recordings is raw and requires pre-processing.

\subsection{Overall Idea}
\subsection{Insert figures}



\section{MCLURS}

% The system supports sampling of 312.5 khz on each channel where the present version of the hardware has 8 channels. 
A recording system has been developed by John Hallam \& T{\'o}rur Andreassen \citep{andreassen2013ultrasonic} named Multi Channel Long-term Ultrasonic Recording System, which is used on most of the usescases list in section \ref{sec:usecase}. The hardware of MCLURS is described in section \ref{sec:currentsystem:hw}. 
However due to the MCLURS's design, it has some limitations which cannot be bypassed without redesigning the overall architecture. Limitations of the existing system is described in section \ref{sec:existingsystem:limitations}.\\


MCLURS is illustrated in figure \ref{fig:existingsystem:overview}. The yellow and blue boxes are hardware and software components respectively.
\todo{Fix figure colors. Yellow = hardware, blue = software}
\begin{figure}[h!]
	\centering
	\includegraphics[width=1\textwidth]{figures/existing-system-overview.png} 
	\caption{Overview of existing system. Yellow boxes indicate hardware and blue boxes are software components.}\label{fig:existingsystem:overview}
\end{figure}
\todo{Ad line from USB Microcontroller to Multiplexer}

\todo{Add figure of three hardware components}

\subsection{Hardware}
The hardware used in MCLURS is shown in figure \ref{fig:existingsystem:hardware}.

\missingfigure{Hardware picture of (version 2B and droneboard)}

The hardware consists of 3 PCBs, each listed and described below:
\begin{enumerate}
	\item \textbf{Raspberry PI} The Raspberry PI runs the software described in section \ref{sec:existingsystem:software}. It interfaces the Miscellaneous PCB through GPIO headers on the RPI, and the USBDUX through USB.
	
	\item \textbf{USBdux-fast} The USBdux-fast board is responsible for sampling the 8 channels. The USBDUX-fast has an ADS807 ADC, which is a single channel ADC capable sampling at 53Mhz.\todo{Cite datasheet}.
Since the system has 8 channels, a multiplexer is placed in front of the ADC, that cycles through the 8 channel inputs.
The ADC and multiplexer is controlled by the onboard peripheral USB micocontroller(cy7c68013a) which instructs the ADC when to do sampling and the multiplexer to select channel. The microcontroller is running a firmware as explained in section\ref{sec:existingsystem:software:kernelmodule}.
	
	\item \textbf{Miscellaneous PCB} The Miscellaneous PCB is responsible for the 1W-interface to the microphones\todo{intorducte 1W somewhere}, the RTC, setting gain, filters, LEDs and proving power for the hardware
\end{enumerate}

Four versions of the hardware exists, however; changes from version 1 to version2B where bugfixes and addition of switch to control filters. The two relevant versions are \textit{Version 2B} and droneboard, as shown in figure \ref{fig:existingsystem:hardware:2B} and \ref{fig:existingsystem:hardware:droneboard} respectively.

\begin{itemize}
	\item \textbf{Version2B} Is the version used in existing usecases. 

	\item \textbf{Droneboard} Is to be used in usecase \ref{sec:usecase:drone}. This PCB is designed to be small and light, as it will be mounted on a drone as payload. The PCB is a merge of the \textit{Miscellaneous PCB} and USBDUX-fast, however the ADC has been replaced with a LC2205 that is 16 bits\todo{Cite datasheet}. Except for the size of a sample, the interface from the software perspective reminds the same as Version2B.

\end{itemize}
\myparagraph{Microphone}
Microphones connected to the MCLURS system usually have a small PCB build-in. The PCB contains a DS28E05\todo{Cite datasheet} 112-byte EEPROM, that allows setting microphone calibration parameters and microphone identifier. The microphone is showed in figure \ref{fig:existingsysem:hardware:microhpone}. The build-in PCB also contains circuitry that converts the single-ended output from the internal, actual mirophone into a differential output, in order to reduces the risk of electromagnetic noise.
\missingfigure{Figure of Microphone}

\subsubsection{Software Components} \label{sec:existingsystem:software}
MCLURS consists of a suite of programs, that all have a well defined responsibility. The programs are written in C where the program is time-critical or Perl, if the program is not time critical. \textit{array} is written in bash, as it is the CLI interface to MCLURS that allows starting recordings etc.

Below is listed the programs in MCLURS:
\begin{itemize}
	\item \textbf{snapchot} is responsible for getting the samples from the usbdux/comedi (see section \ref{sec:existingsystem:software:kernelmodule}) module and writing the samples into files. When snapshot is initialized, it will record samples, however data is only saved to a circular buffer until it is told to write the buffer into a file. The snapshot will save part of the circular buffer to a file when it receives a “snap” command. This gives the ability to get a recording, consisting of data from a predefined time before it receives the “snap” command. This makes up the \textit{trigger-recording}. Snapshot is designed to not miss out samples from the comedy device and there by not from the ADC. Snapshot supports long-recordings recordings, where it just repeats the triggering and saves each trig to a file.
	
	\item \textbf{grab} has overlapping responsibility with snapshot, however: grab outputs samples to stdout and not by writing to any files. Furthermore, the implementation of the grab node is much more simple, as it has no need to maintain a circular buffer and thereby implement less memory management. If the consuming process blocks its stdin, grab will loose samples. Grab is usually used to short/long-recordings.

	\item \textbf{snapchat} is responsible for communicating with snapchot and/or array-cmd depending on the usecase. Snapchat takes commands as input and forwards them to snapshot or array-cmd.

	\item \textbf{array-cmd} is responsible for:
	\begin{enumerate}	
		\item Setting up the USBDUX during startup of MCLURS 
		\item Handling GPIO to HMI
		\item Saving meta-data for recordings
		\item Determining mode of operation
		\item Handling connected microphones.
		\item Being the interface to the system using ZMQ and UDP.
		\item Hardware communication with DAC for filtering over I2C.
	\end{enumerate} \todo{Refer to appendix with flowchart of array-cmd}

	
	\item \textbf{trig} instructs the snapshot when to do a snapshot by constructing and sending a “snap” command to either cmd-array or snapchat. It can be told to do snaps repeatedly or only once a button has been pressed.

	\item {array} is a script that hides the complexity of the system to ease the interface for the biologists. It is capable of initializing the system, listing connected microphones, setting options on the microphones, starting/stopping recordings etc.

\end{itemize}


Table \ref{tab:existingsystem:software:nodes} lists the different programs and how they are run, in which language and when they are run. "Daemon" means the program is run under supervison from \textit{runit} and \textit{One-shot} means til program is run when needed.

\begin{table}[h!]
\centering
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|l|l|}
\hline
\textbf{Node name} & \textbf{Impl. Language} & \textbf{Running mode} \\ \hline
Snapshot           & C                       & Daemon                \\ \hline
Snapchat           & C                       & One-shot              \\ \hline
Grab               & C                       & One-shot              \\ \hline
Trig               & C                       & One-shot              \\ \hline
array-cmd          & Perl                    & Daemon                \\ \hline
array              & Bash                    & Oneshot               \\ \hline
\end{tabular}%
}
\caption{My caption}
\label{my-label}
\end{table}


%Hardware - trigger line(master/slave setups)

\myparagraph{Inter Process Communication}
The interface to the recording system is either UDP or ZMQ using request/reply-pattern. Communication between the demons and CLI tools is ZMQ. Communication between threads in snapshot is also using ZMQ, however using push-patterns as ZMQ is used to do logging from busy threads.

\myparagraph{Startup and Supervision}
All daemons are run under supervision from the debian runit package. The runit package is both responsible for starting the nodes during startup, but also to keep the nodes running in case one of them crashes. Since runit does not provide any control of the order of startup, some fiddling has been made in order to start the snapshot and array-cmd in the correct order. 


\todo{Describe and make diagrams of how to userlands tools talk through comedi modules to hardware}

\myparagraph{Kernel module} \label{sec:existingsystem:software:kernelmodule}
\begin{figure}[h!]
	\centering
	\includegraphics[width=0.5\textwidth]{figures/mclurs_comedi}
\end{figure}

\subsubsection{Limitations} \label{sec:exisingsystem:limitations}
An example of this is the need to show the operation on the system live. 
The software running on the system, is implemented on a single RPI. The RPI is designed such that the USB-ports and ethernet is connected to the USB-bus. When the ADC samples at it highest samplerate, it generates 5mb/sec which is.

\begin{itemize}
	\item Not capable of doing online processing of recordings.
\end{itemize}

