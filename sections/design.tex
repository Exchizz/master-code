\chapter{Design}

% http://www.faqs.org/rfcs/rfc5219.html <- mp3 i rtp
% RTP description https://flylib.com/books/en/4.245.1.27/1/
Video conference system(VCS) utilize audio and video streams, as a video conference is a connection between people residing in separate locations. This connection gives the impression that people participating in the video conference are present in the physical meeting. VCS usually allows for multiple participants to join a meeting where all participants are able to see each other. CVS might allow control of the camera by the remote participant in order to look at the person who is currently speaking. 
Lip-sync is often preferred during the video conference, to further give the impression the remote-participant is present. Lip-sync is when the sound from the remote participants is synchronized with the video stream. This usually has to be implemented by the streaming protocols as sound and video is not necessarily transmitted in the same stream and there by not synchronized when received by the recipient.

\missingfigure{sketch of video conference}

VCS usually utilizes the protocols shown in table ~\ref{table:vcs:protocols}. Proprietary VCSs such as Skype use closed protocol specifications which is not included in the table.


\begin{table}[]
	\centering
	\resizebox{\textwidth}{!}{%
		\begin{tabular}{@{}|l|l|l|l|@{}}
			\toprule
			\textbf{Protocol}             & \textbf{Abreviation} & \textbf{Described in} & \textbf{Note} \\ \midrule
			Realtime Transport Protocol   & RTP                  &                       & Transports video, sound etc.\\ \midrule
			RTP Control Protocol          & RTCP                 &                       & Quality feedback, participant identification and timing\\ \midrule
			Session Description Protocol  & SDP                  &                       & Describes a RTP session\\ \midrule
			Session Announcement Protocol & SAP                  &                       & Announces a SDP on multicast group\\ \bottomrule
		\end{tabular}%
	}
	\caption{Table showing protocols usually used in a video conference system.}
	\label{my-label}
\end{table}
\todo{Add RTSP and other non-relevant protocols?}

\section{Real-time Transport Protocol}
The RTP protocol is a network protocol for transmitting audio and video data in Voice-over-IP(VoIP), video conferences and online services that require streaming media. RTP is usually run over UDP, however it might be used over TCP as well.
A RTP session consists of one or more participants who are communicating using RTP. A participant may be active in multiple RTP sessions e.g. one session for streaming audio data and another session for streaming video data. For each participant, the session is identified by an IP and port pair to which data should be sent, and a port pair on which data is received. 

The RTP packet is depicted below:

\begin{figure}[h!]
\begin{verbatim}
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |V=2|P|X|  CC   |M|     PT      |       sequence number         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           timestamp                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           synchronization source (SSRC) identifier            |
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
   |            contributing source (CSRC) identifiers             |
   |                             ....                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{verbatim}
\caption{Box in an old RFC}
\label{fig:ascii-box}
\end{figure}

many applications
profile
 - static
data types
Timestamp is a 32 bit value.
Id
source
yada..

\subsection{RTP payload}

It is important to be aware of the limits of the RTP protocol specification because it is deliberately incomplete in two ways. First, the standard does not specify algorithms for media playout and timing regeneration, synchronization between media streams, error concealment and correction, or congestion control. These are properly the province of the application designer, and because different applications have different needs, it would be foolish for the standard to mandate a single behavior.
The RTP protocol does not specify how the data should be packet into the payload of an RTP packet. This is defined by profiles and packet types. A profile can contain multiple data formats, and might describe some general details about the content of the RTP packet.
The most used profile is the "RTP/AV audio video for conference with minumal control", which is used for streaming audio and video.
RTP contains packet-type field.

\section{Profile}
since the RTP protocol does not specify how the data should be formated into the payload of the RTP body, this is externally defined by profiles. The most used profile is  the AV-profile, which defines several payload-types for the RTP packets. Which profile is in used is dictated by the SDP \ref{sec:design:sdp}. For historial reasons, only a few data types are defined, however from 96-100 allows for dynamic payloads. If a dynamic payload is used, another standard defines how the data must be packed into the payload of the RTP packet.

The profile dictages general parameter that applies for the RTP session such as:
\begin{itemize}
	\item RTCP interal
	\item Packet types
	\item Clock rate in RTP header
	\item Mappings of parameters to the SDP
\end{itemize}

Dynamic types

\cite{perkins2003rtp}
\section{Real-time Control Protocol}
RTCP is used to provide reception quality feedback, participant identification, and synchronization between media streams. RTCP runs alongside RTP and provides periodic reporting of this information. Although data packets are typically sent every few milliseconds , the control protocol operates on the scale of seconds. The information sent in RTCP is necessary for synchronization between media streams ”for example, for lip synchronization between audio and video ”and can be useful for adapting the transmission according to reception quality feedback, and for identifying the participants . 

receiver report (RR), sender report (SR), source description (SDES), membership management (BYE), and application-defined (APP). 

\section{Session Description Protocol}
The Session Description Protocol(SDP) is a format for describing RTP streams. The SDP is widely used in VoIP and conference systems, where relevant parameters must be known before the RTP streams can be decoded and presented. Usually the SDP is used to be sent from the source of the stream, however; in VoIP-systems, the SDP is also sent from the receiver, in order to negotiated supported codecs. In addition to describing parameters, SDP is also widely used to announce multicast streams. 

The SDP describes which profile in use, and describes the format used in the RTP stream if a dynamic type is used.

The SDP is strictly defined key-value pairs. The SDP describes several key's where some must be filled and others are option. A key-value pair is defined as shown below:
<key>=<value>
No spaces are allowed around the key or value.
The order of the keys are dictated by the RFC. The reason for the strict format is to ease parsing and to more easily detect errors in the file.

The most used are listed below:

\todo{SDP liste}

a=rtpmap:<payload type> <encoding name>/<clock rate> [/<encoding parameters>]
Session
Media
A media is defined as:
            m=audio 49232 RTP/AVP 0
           
            m=audio 1337 RTP/AVP 98
When a dynamic packet type is in use, the following parameter is given:
            a=rtpmap:98 L16/16000/2
This associates the the dynamic payload type, 9, with the encoded format which in this case is L16 with a clock frequency of 16000 stereo.

\subsection{Session Announcement Protocol}
\todo{Description of SAP}


\section{Gstreamer}
\todo{Describe gstreamer + pros and cons}
Cons:
 - 64bit timestamp injected
 


\section{RTP Libraries}
\subsection{oRTP} 
The oRTP library is used in \textit{linphone Open-source VoIP}, which is an open-source VoIP solution created and maintained by Belledonne Communications. The oRTP library is released under the GNU GPLv2 and proprietary license meaning the library can be used for open-source projects and in proprietary solutions.
The oRTP library implements RFC3550 with an API that offers a high as well as low level API. The library supports parsing and composing RTP and RTCP packets. It supports multiple RTP sessions with IPv4 and IPv6. Furthermore, it offers support for different profiles, meaning a custom profile can be implemented.  oRTP has a sparse documentation with only an autogenerated doxygen, where most of the functionality is described. The sourcecode comes with simple examples, that explains some of the library functionality. The library is written in C, meaning language bindings can be utilized to interface the library to scripting languages. The oRTP library can be found in ubuntu + debian's packet repository. At the time of writing, the latest commit on their official github has been made 24 days ago which indicates the project is active.

\subsection{jrtplib}
The jrtplib library is developed at the the Expertise Centre for Digital Media (EDM), a research institute of the Hasselt University. At the time of writing the library has been used in 61 projects listed on \href{http://research.edm.uhasselt.be/jori/cgi-bin/listprojects.py?name=jrtplib}{Project list}. The library is free to use, but must include disclaimer in the source. The library implements RFC3550 and provides primarily a highlevel API, that hides most of the implement details. The library is written in C++, which allows for language bindings. The library is  well documented by giving a thoroughly \textit{Getting Started} and includes 7 examples showing how to utilize the functionality of the library. Unfortunately the author has not done any commits for the past year.

\todo{MIT license}
\todo{Add to design requirements, that software exist from repo + maintained}
\todo{Explain \textit{library properties}}

\begin{table}[h!]
\centering
\begin{tabular}{@{}|l|l|l@{}|}
\hline
\multicolumn{1}{|l|}{\textbf{Library property}} & \multicolumn{1}{|l|}{\textbf{oRTP}}         & \multicolumn{1}{|l|}{\textbf{jrtplib}}       \\ \midrule
\multicolumn{1}{|l|}{In repository}    & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{l|}{} \\ \midrule
\multicolumn{1}{|l|}{RTCP impl.} & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Low level API} & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{RTP Profile} & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{API documented}          & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Library Usage}          & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Actively Maintained}           & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{l|}{} \\ \midrule
\multicolumn{1}{|l|}{IPv6 multicast support}           & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Existing perl-binding}           & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Multiple RTP sessions support}           & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Send \& Receive}           & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark} \\ \midrule
\multicolumn{1}{|l|}{Includes examples}           & \multicolumn{1}{c|}{\checkmark} & \multicolumn{1}{c|}{\checkmark}  \\ \bottomrule
\end{tabular}
\caption{Comparesion of oRTP and jrtplib}
\label{my-label}
\end{table}


\section{Stream Topology}

Master vs. nomaster
cost of wellknown information at all ends.
